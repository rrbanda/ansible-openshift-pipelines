# 🛠 Ansible Playbook Promotion with Tekton Pipelines

This repository demonstrates a CI pipeline using [Tekton Pipelines](https://tekton.dev) to automatically lint, validate, and promote Ansible playbooks from a working branch (`dev`) into production-ready state (`main`).

## 💡 Demo Story

In most real-world teams, infrastructure code like Ansible playbooks needs to pass lint checks before it’s allowed into production. This pipeline enforces that.

Here’s the workflow:
- Developers push all playbooks (good or bad) to the `dev` branch under `samples/`.
- The pipeline:
  1. Runs `ansible-lint` on each file.
  2. Fails fast if **all files** are bad.
  3. If some pass, only those get promoted.
  4. A `lint-summary.md` file is generated and committed.
  5. A PR to `main` is auto-created (and merged if fully clean).
  6. Failed PR branches are auto-cleaned.

The `main` branch stays clean — it never has a `samples/` folder. Only valid playbooks go to `ansible/`.

---

## 🚀 Getting Started

### 1. Prerequisites

- OpenShift or Kubernetes cluster with Tekton Pipelines installed.
- A PersistentVolumeClaim named `ansible-tekton-pvc`.
- A GitHub access token stored in a Kubernetes Secret:
  ```bash
  kubectl create secret generic github-creds \
    --from-literal=token=<your_token> \
    -n <your-namespace>
  ```

---

### 2. File Layout

```
dev/
└── samples/
    ├── hello-world.yml       ✅ good file
    └── bad.yml               ❌ fails lint
```

After promotion, main will have:

```
main/
├── ansible/
│   └── hello-world.yml
└── lint-summary.md
```

---

### 3. How to Run the Pipeline

Apply the following Tekton resources:

```bash
kubectl apply -f pipeline.yaml
kubectl apply -f task-promote-playbook.yaml
kubectl apply -f pipelinerun-promote-dev-to-main.yaml
```

You can monitor the pipeline via the OpenShift Console or Tekton CLI:

```bash
tkn pipelinerun logs -f -n <your-namespace>
```

---

## ✅ Testing Scenarios

### ✅ Test a Clean Run

1. Keep only valid `.yml` files under `dev/samples/`.
2. Run the pipeline.
3. It creates a PR to `main` with:
   - Only the passing files copied to `ansible/`
   - A `lint-summary.md` in the root
   - Auto-merge to `main`

### ❌ Test a Failure

1. Add a broken file to `samples/`:
   ```yaml
   - hosts: localhost
     tasks:
       - debug: msg="bad task with no name"
   ```
2. Run the pipeline.
3. The PR will be auto-deleted.
4. A lint summary will still be posted as a PR comment.

---

## 📋 Lint Summary Format

Example `lint-summary.md`:

```markdown
# Lint Summary Report

| Playbook           | Status   |
|--------------------|----------|
| hello-world.yml    | ✅ Passed |
| bad.yml            | ❌ Failed |

_Auto-generated by Tekton at 2025-04-23 14:32:00 UTC_
```

---

## 📌 Notes

- `samples/` is treated as **input only** and must exist only in `dev`.
- `main` should never contain `samples/` — the pipeline enforces this.
- The pipeline doesn't lint files outside `samples/`.

---

## 🧼 Cleanup

To delete the pipeline run or clean up old promote branches:
```bash
kubectl delete pipelinerun promote-dev-to-main
```

Or delete from GitHub if needed:
```bash
git push origin --delete promote-<timestamp>
```

---

